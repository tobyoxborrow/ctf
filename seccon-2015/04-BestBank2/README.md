# 04 Best Bank 2

The Best Bank website has been upgraded to prevent vulnerabilities of the past.
The electronic cheques now include an HMAC of the transaction to verify it has
not been tampered with.

To receive the flag, deposit a cheque in any bank account for at least $5000.
Your own account only has $200.

The restrictions of the bank website also prevent you from creating cheques for
greater than $1000.

Access to the ruby source code used by the bank to generate the cheques was
provided. The HMAC's secret key is redacted from the source code.

## Write-up

Issue a test transfer to see the format.

```
Transfer from tobyox to aaaa amount $200:

dG9ieW94O2FhYWE7MjAwO2JhMzk3NzFlOWFiMmNmMjc3NDVlNjA1ZDIwY2ZiZTRkYzZkZTgyMThlMzVhMzc3YWNmYzQyNTkxN2E2NGVlNjI=

Transfer from tobyox to tobyox amount $200:

dG9ieW94O3RvYnlveDsyMDA7MzRlMjllNTNmMzNjY2UxOTM2YzFlZTk5OTViN2FkY2E2MDE1MmI4NGIzMTczY2U3MmJiMWRhODJhMGMwMjUzNQ==
```

Base64 again.

```
% echo "dG9ieW94O2FhYWE7MjAwO2JhMzk3NzFlOWFiMmNmMjc3NDVlNjA1ZDIwY2ZiZTRkYzZkZTgyMThlMzVhMzc3YWNmYzQyNTkxN2E2NGVlNjI=" | base64 --decode
tobyox;aaaa;200;ba39771e9ab2cf27745e605d20cfbe4dc6de8218e35a377acfc425917a64ee62

% echo "dG9ieW94O3RvYnlveDsyMDA7MzRlMjllNTNmMzNjY2UxOTM2YzFlZTk5OTViN2FkY2E2MDE1MmI4NGIzMTczY2U3MmJiMWRhODJhMGMwMjUzNQ==" | base64 --decode
tobyox;tobyox;200;34e29e53f33cce1936c1ee9995b7adca60152b84b3173ce72bb1da82a0c02535
```

In the ruby source code used to generate cheques, it appeared as though the
HMAC only verified the from/to names, not the value. We should be able to take
the HMAC from a previous message generated by the live system and append it to
our own cheque.

```
def foo(from, to, value, hmac)
  plaintext_check = "#{from};#{to}"
  Base64.encode64("#{plaintext_check};#{value};#{hmac}").gsub(/\s+/, "")
end

puts foo('tobyox', 'tobyox', '9000', '34e29e53f33cce1936c1ee9995b7adca60152b84b3173ce72bb1da82a0c02535')
```

And run it:

```
% ruby create_check.rb
dG9ieW94O3RvYnlveDs5MDAwOzM0ZTI5ZTUzZjMzY2NlMTkzNmMxZWU5OTk1YjdhZGNhNjAxNTJiODRiMzE3M2NlNzJiYjFkYTgyYTBjMDI1MzU=
```

It worked.

```
Enter check:
Check deposited successfully. Your new balance is 9200

Congratulations! Here is the flag:

Sh0wM3Th3m0ney

Home
```
